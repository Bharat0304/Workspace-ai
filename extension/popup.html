<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Focus Guard</title>
    <style>
      body { font-family: system-ui, sans-serif; margin: 12px; min-width: 220px; }
      button { padding: 8px 10px; margin-right: 8px; }
      .row { margin-bottom: 10px; }
      .status { font-size: 12px; color: #555; }
    </style>
  </head>
  <body>
    <div class="row">
      <button id="lockBtn">Lock to current tab</button>
      <button id="unlockBtn">Unlock</button>
    </div>
    <div class="row">
      <label><input type="checkbox" id="enabled" /> Enforcement enabled</label>
    </div>
    <div class="row status" id="status">Loadingâ€¦</div>
    <script type="module">
      const lockBtn = document.getElementById('lockBtn');
      const unlockBtn = document.getElementById('unlockBtn');
      const enabledEl = document.getElementById('enabled');
      const statusEl = document.getElementById('status');

      async function getActiveTab() {
        const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
        return tab;
      }

      function domainFromUrl(url) {
        try { return new URL(url).hostname.replace(/^www\./, ''); } catch { return null; }
      }

      async function refreshStatus() {
        const { allow = [], lockedDomain = null, enabled = true } = await chrome.storage.sync.get(['allow','lockedDomain','enabled']);
        enabledEl.checked = enabled;
        statusEl.textContent = lockedDomain ? `Locked to: ${lockedDomain}` : `Allowing: ${allow.join(', ') || 'none'}`;
      }

      lockBtn.addEventListener('click', async () => {
        const tab = await getActiveTab();
        const domain = domainFromUrl(tab?.url || '');
        if (!domain) { alert('Unable to detect domain from current tab'); return; }
        await chrome.runtime.sendMessage({ type: 'lock-domain', domain });
        await refreshStatus();
      });

      unlockBtn.addEventListener('click', async () => {
        await chrome.runtime.sendMessage({ type: 'unlock-domain' });
        await refreshStatus();
      });

      enabledEl.addEventListener('change', async () => {
        const enabled = enabledEl.checked;
        await chrome.storage.sync.set({ enabled });
        await chrome.runtime.sendMessage({ type: 'update-rules', enabled });
        await refreshStatus();
      });

      refreshStatus();
    </script>
  </body>
</html>
